<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Management</title>
    <link rel="icon" href="data:,">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #16a34a;
            --danger-color: #dc2626;
            --background-color: #f3f4f6;
            --card-background: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --table-border-color: #ddd;
            --hover-background: #f5f5f5;
            --error-background: #ffcdd2;
        }

        /* Base Styles */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Form Elements */
        input, button, select {
            margin: 10px 5px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            border: none;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        /* Header Styles */
        .header {
            background-color: var(--card-background);
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        /* Container Styles */
        .container {
            background-color: var(--background-color);
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /* Table Styles */

        .lesson-table th,
        .lesson-table td {
            padding: 12px;
            border: 1px solid var(--table-border-color);
            text-align: left;
        }

        .lesson-table th {
            background-color: var(--background-color);
            font-weight: bold;
        }

        .lesson-table tr:hover {
            background-color: var(--hover-background);
        }

        /* Content Section Styles */
        .content-section {
            margin: 0;
            padding: 15px;
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        .content-header {
            background-color: var(--background-color);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .content-header h4 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .content-body {
            padding: 15px;
            background-color: white;
        }

        /* Button Styles */
        .hide-content-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
            display: inline-block;
        }

        .hide-content-button:hover {
            background-color: var(--secondary-color);
        }

        /* Table Content Styles */
        td .content-section {
            margin-top: 0;
            border: none;
            border-bottom: 1px solid var(--border-color);
        }

        td .content-section:last-child {
            border-bottom: none;
        }

        td .hide-content-button {
            font-size: 0.8rem;
            padding: 2px 6px;
        }

        .content-separator {
            border: 0;
            height: 1px;
            background: #ddd;
            margin: 20px 0;
        }

        /* Error and Status Messages */
        .error-message {
            color: var(--danger-color);
            background-color: var(--error-background);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .detail-display {
            padding: 0.5rem;
            background-color: #f5f5f5;
            border-radius: 4px;
            min-height: 1.5rem;
        }

        .generation-options {
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .lesson-details {
            padding: 2rem;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .detail-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .detail-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .detail-card label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }

        .detail-display {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 500;
            word-break: break-word;
        }

        .content-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }

        .content-button, .hide-content-button {
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .content-button:hover, .hide-content-button:hover {
            background: #2563eb;
        }

        .hide-content-button {
            background: #64748b;
        }

        .hide-content-button:hover {
            background: #475569;
        }

        .content-section {
            background: #f8fafc;
            border-radius: 6px;
            margin-top: 1rem;
            border: 1px solid #e2e8f0;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .content-header h4 {
            margin: 0;
            color: #1e293b;
            font-weight: 600;
        }

        .content-body {
            padding: 1rem;
        }

        .generation-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .generation-options {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        select, input {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.875rem;
            width: 100%;
            margin-top: 0.25rem;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        h3 {
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }


    </style>
</head>
<body>
    <div class="header">
        <h1>Lesson Management System</h1>
        <button onclick="window.location.href='login.html'" style="position: absolute; top: 60px; right: 20px;" class="hide-content-button">
            Logout
        </button>
        <button onclick="window.location.href='landing.html'" style="position: absolute; top: 20px; right: 20px;" class="hide-content-button">
            Home
        </button>
    </div>

    <div class="content-buttons" style="margin: 20px 0; display: flex; gap: 10px;">
        <button class="hide-content-button active" onclick="showSection('searchLessons')">Search Lessons</button>
        <button class="hide-content-button" onclick="showSection('addLesson')">Add New Lesson</button>
        <button class="hide-content-button" onclick="showSection('updateLesson')">Update Lesson</button>
        <button class="hide-content-button" onclick="showSection('deleteLesson')">Delete Lesson</button>
    </div>

    <div id="searchLessons" class="container">
        <h2>Search Lessons</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div style="display: flex; flex-direction: column;">
                <label for="subject">Subject</label>
                <input type="text" id="subject" placeholder="Enter subject name">
            </div>

            <div style="display: flex; flex-direction: column;">
                <label for="topic">Topic</label>
                <input type="text" id="topic" placeholder="Enter lesson topic">
            </div>

            <div style="display: flex; flex-direction: column;">
                <label>Pupil ID Range</label>
                <div style="display: flex; gap: 0.5rem;">
                    <label for="fromPupilId"></label><input type="number" id="fromPupilId" placeholder="From" style="flex: 1;">
                    <label for="toPupilId"></label><input type="number" id="toPupilId" placeholder="To" style="flex: 1;">
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
            <div style="display: flex; flex-direction: column;">
                <label>Sort Options</label>
                <div style="display: flex; gap: 0.5rem;">
                    <label for="sort"></label><select id="sort" style="flex: 1;">
                        <option value="id">ID</option>
                        <option value="subject">Subject</option>
                        <option value="topic">Topic</option>
                    </select>
                    <label for="sortDirection"></label><select id="sortDirection" style="flex: 1;">
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; align-items: flex-end;">
                <div style="display: flex; gap: 0.5rem;">
                    <div style="display: flex; flex-direction: column;">
                        <label for="page">Page</label>
                        <input type="number" id="page" value="1" min="1" style="width: 80px;">
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <label for="count">Per Page</label>
                        <input type="number" id="count" value="50" min="1" style="width: 80px;">
                    </div>
                </div>
            </div>
        </div>

        <button onclick="searchLessons()" class="hide-content-button" style="margin-top: 1rem;">Search Lessons</button>
        <div id="searchResults" style="margin-top: 1rem;"></div>
    </div>

    <div id="addLesson" class="container" style="display: none;">
        <h2>Add New Lesson</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div style="display: flex; flex-direction: column;">
                <label for="newSubject">Subject</label>
                <input type="text" id="newSubject" placeholder="Enter subject name">
            </div>

            <div style="display: flex; flex-direction: column;">
                <label for="newTopic">Topic</label>
                <input type="text" id="newTopic" placeholder="Enter lesson topic">
            </div>

            <div style="display: flex; flex-direction: column;">
                <label for="newPupilId">Pupil ID</label>
                <input type="number" id="newPupilId" placeholder="Enter pupil ID">
            </div>

            <div style="display: flex; flex-direction: column;">
                <label for="newActivityType">Activity Type</label>
                <select id="newActivityType">
                    <option value="Classroom">Frontal lecture in class</option>
                    <option value="Computerized">A computerized class</option>
                    <option value="GroupWork">Group discussion</option>
                    <option value="OutSide">Lesson outside the classroom</option>
                    <option value="Remote">Online lesson</option>
                    <option value="Emotional">Based on personality traits</option>
                    <option value="Reinforcement">Based on interests</option>
                </select>
            </div>

            <div style="display: flex; flex-direction: column;">
                <label for="newKnownGame">Game Type</label>
                <select id="newKnownGame">
                    <option value="Hangman">Hangman</option>
                    <option value="Memory">Memory</option>
                    <option value="Charades">Charades</option>
                    <option value="Bingo">Bingo</option>
                    <option value="ScavengerHunt">Scavenger Hunt</option>
                </select>
            </div>

            <div style="display: flex; flex-direction: column;">
                <label for="newImageDescription">Image Description</label>
                <input type="text" id="newImageDescription" placeholder="Enter image description">
            </div>
        </div>
        <button onclick="addLesson()" class="hide-content-button" style="margin-top: 1rem;">Add Lesson</button>
        <div id="addLessonResult" style="margin-top: 1rem;"></div>
        <div id="taskStatus" style="margin-top: 1rem;"></div>
        <div id="generatedLessonDisplay" style="margin-top: 2rem;"></div>
    </div>

    <div id="updateLesson" class="container" style="display: none;">
        <h2>Update Lesson</h2>

        <!-- Step 1: Initial ID Input -->
        <div id="lessonIdInput" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div style="display: flex; flex-direction: column;">
                <label for="updateLessonId">Lesson ID</label>
                <input type="number" id="updateLessonId" placeholder="Enter lesson ID">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="updatePupilId">Pupil ID</label>
                <input type="number" id="updatePupilId" placeholder="Enter pupil ID">
            </div>
        </div>
        <button onclick="fetchLessonDetails()" class="hide-content-button" style="margin-top: 1rem;">Find Lesson</button>

        <!-- Step 2: Lesson Details and Generation Options -->
        <div id="lessonDetails" style="display: none; margin-top: 2rem;">
            <div style="margin-bottom: 1rem;">
                <h3>Lesson Details</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div style="display: flex; flex-direction: column;">
                        <label>Subject</label>
                        <div id="lessonSubject" class="detail-display"></div>
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <label>Topic</label>
                        <div id="lessonTopic" class="detail-display"></div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem;">
                <h3>Generation Options</h3>
                <div class="generation-buttons" style="display: flex; gap: 10px; margin-top: 1rem;">
                    <button onclick="toggleGenerationOptions('all')" class="hide-content-button">Regenerate All</button>
                    <button onclick="toggleGenerationOptions('plan')" class="hide-content-button">Generate Plan</button>
                    <button onclick="toggleGenerationOptions('game')" class="hide-content-button">Generate Game</button>
                    <button onclick="toggleGenerationOptions('image')" class="hide-content-button">Generate Image</button>
                </div>

                <!-- Generation Option Forms -->
                <div id="allGenerationOptions" class="generation-options" style="display: none; margin-top: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="display: flex; flex-direction: column;">
                            <label for="updateActivityType">Activity Type</label>
                            <select id="updateActivityType">
                                <option value="Classroom">Frontal lecture in class</option>
                                <option value="Computerized">A computerized class</option>
                                <option value="GroupWork">Group discussion</option>
                                <option value="OutSide">Lesson outside the classroom</option>
                                <option value="Remote">Online lesson</option>
                                <option value="Emotional">Based on personality traits</option>
                                <option value="Reinforcement">Based on interests</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <label for="updateKnownGame">Known Game</label>
                            <select id="updateKnownGame">
                                <option value="Hangman">Hangman</option>
                                <option value="Memory">Memory</option>
                                <option value="Charades">Charades</option>
                                <option value="Bingo">Bingo</option>
                                <option value="ScavengerHunt">Scavenger Hunt</option>
                            </select>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <label for="updateImageDescription">Image Description</label>
                            <input type="text" id="updateImageDescription" placeholder="Enter image description">
                        </div>
                    </div>
                    <button onclick="handleGeneration('all')" class="hide-content-button" style="margin-top: 1rem;">Generate All</button>
                </div>

                <div id="planGenerationOptions" class="generation-options" style="display: none; margin-top: 1rem;">
                    <div style="display: flex; flex-direction: column; max-width: 250px;">
                        <label for="updatePlanActivityType">Activity Type</label>
                        <select id="updatePlanActivityType">
                            <option value="Classroom">Frontal lecture in class</option>
                            <option value="Computerized">A computerized class</option>
                            <option value="GroupWork">Group discussion</option>
                            <option value="OutSide">Lesson outside the classroom</option>
                            <option value="Remote">Online lesson</option>
                            <option value="Emotional">Based on personality traits</option>
                            <option value="Reinforcement">Based on interests</option>
                        </select>
                    </div>
                    <button onclick="handleGeneration('plan')" class="hide-content-button" style="margin-top: 1rem;">Generate Plan</button>
                </div>

                <div id="gameGenerationOptions" class="generation-options" style="display: none; margin-top: 1rem;">
                    <div style="display: flex; flex-direction: column; max-width: 250px;">
                        <label for="updateGameType">Known Game</label>
                        <select id="updateGameType">
                            <option value="Hangman">Hangman</option>
                            <option value="Memory">Memory</option>
                            <option value="Charades">Charades</option>
                            <option value="Bingo">Bingo</option>
                            <option value="ScavengerHunt">Scavenger Hunt</option>
                        </select>
                    </div>
                    <button onclick="handleGeneration('game')" class="hide-content-button" style="margin-top: 1rem;">Generate Game</button>
                </div>

                <div id="imageGenerationOptions" class="generation-options" style="display: none; margin-top: 1rem;">
                    <div style="display: flex; flex-direction: column; max-width: 250px;">
                        <label for="updateImageDesc">Image Description</label>
                        <input type="text" id="updateImageDesc" placeholder="Enter image description">
                    </div>
                    <button onclick="handleGeneration('image')" class="hide-content-button" style="margin-top: 1rem;">Generate Image</button>
                </div>
            </div>
        </div>

        <div id="updateLessonResult" style="margin-top: 1rem;"></div>
    </div>

    <div id="deleteLesson" class="container" style="display: none;">
        <h2>Delete Lesson</h2>
        <div style="display: flex; gap: 1rem; align-items: flex-end;">
            <div style="display: flex; flex-direction: column;">
                <label for="deleteLessonId">Lesson ID</label>
                <input type="number" id="deleteLessonId" placeholder="Enter lesson ID">
            </div>
            <button onclick="deleteLesson()" class="hide-content-button">Delete Lesson</button>
        </div>
        <div id="deleteLessonResult" style="margin-top: 1rem;"></div>
    </div>

    <script>
        const API_BASE_URL = '/api/pupils/lessons';
        const jwtToken = localStorage.getItem('jwtToken');

        axios.defaults.headers.common['Authorization'] = `Bearer ${jwtToken}`;

        // Styles for loading animation
        const loadingStyles = `
        .loading-container {
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #e9ecef;
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        .loading-message {
            color: #495057;
            font-size: 1.1em;
            margin: 10px 0;
        }

        .loading-progress {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 8px;
        }

        .loading-dots {
            display: inline-block;
            width: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        `;

        function displaySearchResults(responseData) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';

            if (!responseData.data || !Array.isArray(responseData.data)) {
                resultsDiv.innerHTML = '<p class="no-results">No lessons found.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'lesson-table';

            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['ID', 'Created At', 'Subject', 'Topic', 'Game Type', 'Plan Activity', 'Image Description', 'Pupil ID', 'Actions'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            responseData.data.forEach(lesson => {
                const row = document.createElement('tr');

                // Add regular cells
                [
                    lesson.id,
                    lesson.createdat,
                    lesson.subject,
                    lesson.topic,
                    lesson.gametype,
                    lesson.planactivity,
                    lesson.imagedescription,
                    lesson.pupilid
                ].forEach(text => {
                    const td = document.createElement('td');
                    td.textContent = text || 'N/A';
                    row.appendChild(td);
                });

                // Add actions cell with content buttons
                const actionsCell = document.createElement('td');
                const contentButtons = document.createElement('div');
                contentButtons.className = 'content-buttons';

                ['Image', 'Game', 'Plan'].forEach(contentType => {
                    const button = document.createElement('button');
                    button.className = 'content-button';
                    button.textContent = `Display ${contentType}`;
                    button.onclick = () => showSpecificContent(lesson.pupilid, lesson.id, contentType.toLowerCase());
                    contentButtons.appendChild(button);
                });

                actionsCell.appendChild(contentButtons);
                row.appendChild(actionsCell);
                tbody.appendChild(row);

                // Add a row for content (initially hidden)
                const contentRow = document.createElement('tr');
                contentRow.id = `content-row-${lesson.id}`;
                contentRow.style.display = 'none';
                const contentCell = document.createElement('td');
                contentCell.colSpan = 9;
                contentRow.appendChild(contentCell);
                tbody.appendChild(contentRow);
            });

            table.appendChild(tbody);
            resultsDiv.appendChild(table);

            if (responseData.pagination) {
                const paginationInfo = document.createElement('div');
                paginationInfo.className = 'pagination-info';

                const paginationDetails = [
                    `Current Page: ${responseData.pagination.page}`,
                    `Total Pages: ${responseData.pagination.ofPage}`,
                    `Total Results: ${responseData.pagination.count}`
                ];

                paginationDetails.forEach(detail => {
                    const span = document.createElement('span');
                    span.className = 'pagination-detail';
                    span.textContent = detail;
                    paginationInfo.appendChild(span);

                    // Add separator except for last item
                    if (detail !== paginationDetails[paginationDetails.length - 1]) {
                        const separator = document.createElement('span');
                        separator.className = 'pagination-separator';
                        separator.textContent = ' | ';
                        paginationInfo.appendChild(separator);
                    }
                });

                resultsDiv.appendChild(paginationInfo);
            }
        }

        async function showSpecificContent(pupilId, lessonId, contentType) {
            try {
                const lesson = await getLesson(pupilId, lessonId, 'getOnePupilResult');
                const contentRow = document.getElementById(`content-row-${lessonId}`);
                const contentCell = contentRow.firstChild;

                contentCell.innerHTML = `
                    <div class="content-section">
                        <div class="content-header">
                            <h4>${contentType.charAt(0).toUpperCase() + contentType.slice(1)} Content</h4>
                            <button class="hide-content-button" onclick="hideContentRow(${lessonId})">Hide Content</button>
                        </div>
                        <div class="content-body">
                            ${getContentByType(lesson, contentType)}
                        </div>
                    </div>
                `;

                contentRow.style.display = 'table-row';
            } catch (error) {
                handleError(error, `content-row-${lessonId}`, 'Error fetching lesson content');
            }
        }

        function getContentByType(lesson, contentType) {
            switch (contentType) {
                case 'image':
                    return lesson.imageurl ?
                        `<a href="${lesson.imageurl}" class="image-link" target="_blank" rel="noopener noreferrer">
                            ${lesson.imageurl}
                        </a>` :
                        'No image content available';
                case 'game':
                    return formatTextContent(lesson.gamedescription);
                case 'plan':
                    return formatTextContent(lesson.plandescription);
                default:
                    handleError(new Error('Content type not recognized'), 'searchResult', 'invalid Lesson content type');
                    return;
            }
        }

        function hideContentRow(lessonId) {
            const contentRow = document.getElementById(`content-row-${lessonId}`);
            if (contentRow) {
                contentRow.style.display = 'none';
            }
        }

        async function getLesson(pupilId, lessonId, elementId) {
            try {
                const response = await axios.get(`${API_BASE_URL}/${pupilId}/${lessonId}/display`);
                return response.data;
            } catch (error) {
                handleError(error, elementId, 'Error fetching lesson details');
            }
        }

        function formatTextContent(text) {
            if (!text) return 'No content available';

            const formattedText = text
                // Handle h3 headers (###)
                .replace(/^###\s+(.*?)$/gm, '<h3>$1</h3>')
                // Handle h4 headers (####)
                .replace(/^####\s+(.*?)$/gm, '<h4>$1</h4>')
                // Handle separator line
                .replace(/^\s*---\s*$/gm, '<hr class="content-separator">')
                // Handle multiple newlines as paragraph breaks
                .replace(/\n{2,}/g, '</p><p>')
                // Handle single newlines as line breaks
                .replace(/\n/g, '<br>')
                // Handle bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Handle italic text
                .replace(/\*(.*?)\*/g, '<em>$1</em>');

            return `<div class="formatted-content"><p>${formattedText}</p></div>`;
        }

        async function searchLessons() {
            const params = {
                subject: document.getElementById('subject').value,
                topic: document.getElementById('topic').value,
                fromPupilId: document.getElementById('fromPupilId').value,
                toPupilId: document.getElementById('toPupilId').value,
                page: document.getElementById('page').value,
                count: document.getElementById('count').value,
                sort: document.getElementById('sort').value,
                sortDirection: document.getElementById('sortDirection').value
            };

            // Remove null values from params
            Object.keys(params).forEach(key => params[key] === null && delete params[key]);

            try {
                const response = await axios.get(API_BASE_URL, { params });
                displaySearchResults(response.data);
            } catch (error) {
                handleError(error, 'searchResults', 'Error searching lessons');
            }
        }

        async function addLesson() {
            const lessonData = {
                subject: document.getElementById('newSubject').value,
                topic: document.getElementById('newTopic').value
            };

            const pupilId = document.getElementById('newPupilId').value;
            const params = {
                activityType: document.getElementById('newActivityType').value,
                knownGame: document.getElementById('newKnownGame').value,
                imageDescription: document.getElementById('newImageDescription').value
            };

            // Validate required fields
            if (!lessonData.subject || !lessonData.topic || !pupilId) {
                displayError('addLessonResult', 'Please fill in all required fields');
                return;
            }

            const url = `${API_BASE_URL}/${pupilId}/lessons`;
            const loadingHandler = new LoadingStateHandler();
            const display = document.getElementById('taskStatus');

            // Start loading animation
            const loadingInterval = loadingHandler.startLoading('all', display);
            try {

                const response = await axios.post(url, lessonData, { params });
                const result = await pollTaskCompletion(response.data.taskId);

                // Stop loading animation
                loadingHandler.stopLoading(loadingInterval);

                display.innerHTML = ``;
                displayGeneratedLesson(result);
            } catch (error) {
                loadingHandler.stopLoading(loadingInterval);
                handleError(error, 'addLessonResult', 'Error adding lesson');
            }
        }

        async function pollTaskCompletion(taskId) {
            const statusUrl = `${API_BASE_URL}/status/${taskId}`;
            const maxAttempts = 180; // 5 minutes maximum (with 2-second intervals)
            let attempts = 0;

            while (attempts < maxAttempts) {
                const response = await axios.get(statusUrl);

                if (response.data.status === 'processing') {
                    // Still processing, wait 5 seconds before next attempt
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    attempts++;
                    continue;
                }

                // Task completed successfully
                return response.data;
            }

            throw new Error('Task timed out');
        }

        function displayGeneratedLesson(result) {
            const display = document.getElementById('generatedLessonDisplay');
            display.innerHTML = `
                <h3>Lesson Generated Successfully</h3>
                <div class="lesson-details">
                    <p><strong>Activity Type:</strong> ${result.planactivity}</p>
                    <p><strong>Game Type:</strong> ${result.gametype}</p>

                    ${result.plandescription ? `
                        <div class="expandable-section">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>Lesson Plan</strong>
                                <button onclick="toggleContent('planContent')" class="hide-content-button">Show/Hide Plan</button>
                            </div>
                            <div id="planContent" style="display: none; margin-top: 1rem;">
                                ${formatTextContent(result.plandescription)}
                            </div>
                        </div>
                    ` : ''}

                    ${result.gamedescription ? `
                        <div class="expandable-section" style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>Game Description</strong>
                                <button onclick="toggleContent('gameContent')" class="hide-content-button">Show/Hide Game</button>
                            </div>
                            <div id="gameContent" style="display: none; margin-top: 1rem;">
                                ${formatTextContent(result.gamedescription)}
                            </div>
                        </div>
                    ` : ''}

                    ${result.imageurl ? `
                        <div class="expandable-section" style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>Generated Image</strong>
                                <button onclick="toggleContent('imageContent')" class="hide-content-button">Show/Hide Image</button>
                            </div>
                            <div id="imageContent" style="display: none; margin-top: 1rem;">
                                <img src="${result.imageurl}" alt="Generated lesson image" style="max-width: 300px;">
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('addLessonResult').innerHTML = '<div class="success">Lesson added successfully!</div>';
        }

        function displayError(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="error">${message}</div>`;
        }

        function handleError(error, resultElementId, defaultMessage) {
            console.error(defaultMessage, error);
            let message = defaultMessage;

            if (error.response) {
                switch (error.response.status) {
                    case 401:
                        alert('Your session has expired. Redirecting to login page.');
                        window.location.href = 'login.html';
                        return;
                    case 409:
                        message = 'A conflict occurred. The resource might already exist.';
                        break;
                    case 404:
                        message = 'The requested resource was not found.';
                        break;
                    case 500:
                        message = 'An internal server error occurred. Please try again later.';
                        break;
                    default:
                        message = `An error occurred: ${error.response.data.message || error.message}`;
                }
            } else if (error.request) {
                message = 'No response received from the server. Please check your network connection.';
            } else {
                message = error.message || defaultMessage;
            }

            const resultElement = document.getElementById(resultElementId);
            if (resultElement) {
                resultElement.innerHTML = `<div class="error-message">${message}</div>`;
            } else {
                console.warn(`Element with id '${resultElementId}' not found. Error message: ${message}`);
            }
        }

        async function handleGeneration(type) {
            const pupilId = document.getElementById('updatePupilId').value;
            const lessonId = document.getElementById('updateLessonId').value;

            let endpoint = `${API_BASE_URL}/${pupilId}/${lessonId}`;
            let params = new URLSearchParams();

            switch (type) {
                case 'all':
                    endpoint += '/regenerate';
                    params.append('activityType', document.getElementById('updateActivityType').value);
                    params.append('knownGame', document.getElementById('updateKnownGame').value);
                    params.append('imageDescription', document.getElementById('updateImageDescription').value);
                    break;
                case 'plan':
                    endpoint += '/plan';
                    params.append('activityType', document.getElementById('updatePlanActivityType').value);
                    break;
                case 'game':
                    endpoint += '/game';
                    params.append('knownGame', document.getElementById('updateGameType').value);
                    break;
                case 'image':
                    endpoint += '/image';
                    params.append('imageDescription', document.getElementById('updateImageDesc').value);
                    break;
            }

            const loadingHandler = new LoadingStateHandler();
            const display = document.getElementById('updateLessonResult');

            // Start loading animation
            const loadingInterval = loadingHandler.startLoading(type, display);

            try {

                const response = await axios.put(`${endpoint}?${params.toString()}`);
                const result = await pollTaskCompletion(response.data.taskId);

                // Stop loading animation
                loadingHandler.stopLoading(loadingInterval);

                switch (type) {
                    case 'all':
                        display.innerHTML = `
                            <h3>Lesson Generated Successfully</h3>
                            <div class="lesson-details">
                                <p><strong>Activity Type:</strong> ${result.planactivity}</p>
                                <p><strong>Game Type:</strong> ${result.gametype}</p>
                                ${result.plandescription ? `<p><strong>Lesson Plan:</strong> ${formatTextContent(result.plandescription)} target="_blank">View Plan </p>` : ''}
                                ${result.gamedescription ? `<p><strong>Game Description:</strong> ${formatTextContent(result.gamedescription)} target="_blank">View Game </p>` : ''}
                                ${result.imageurl ? `<p><strong>Generated Image:</strong> <img src="${result.imageurl}" alt="Generated lesson image" style="max-width: 300px;"></p>` : ''}
                            </div>
                        `
                        break;
                    case 'plan':
                        display.innerHTML = `
                            <h3>Lesson Plan Generated Successfully</h3>
                            <div class="lesson-details">
                                <p><strong>Activity Type:</strong> ${result.planactivity}</p>
                                <p><strong>Lesson Plan:</strong> ${formatTextContent(result.plandescription)} <\p>}
                            </div>
                        `
                        break;
                    case 'game':
                        display.innerHTML = `
                            <h3>Game Generated Successfully</h3>
                            <p><strong>Game Type:</strong> ${result.gametype}</p>
                            <p><strong>Game Description:</strong> ${formatTextContent(result.gamedescription)} </p>}
                        `
                        break;
                    case 'image':
                        display.innerHTML = `
                            <h3>Image Generated Successfully</h3>
                            <img src="${result.imageurl}" alt="Generated lesson image" style="max-width: 300px;"></p>
                        `
                        break;
                }
            } catch (error) {
                loadingHandler.stopLoading(loadingInterval);
                document.getElementById('updateLessonResult').innerHTML =
                    `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        class LoadingStateHandler {
            constructor() {
                // Add styles to document
                const styleSheet = document.createElement('style');
                styleSheet.textContent = loadingStyles;
                document.head.appendChild(styleSheet);

                this.startTime = Date.now();
                this.dots = '';
                this.currentMessageIndex = 0;
                this.currentTipIndex = 0;
            }

            getMessages(type) {
                const messages = {
                    all: [
                        "🎨 Crafting your perfect lesson...",
                        "📚 Blending educational magic...",
                        "🎮 Adding fun elements...",
                        "🖼️ Creating visuals...",
                        "✨ Almost there, making it special...",
                        "🌟 Final touches..."
                    ],
                    plan: [
                        "📝 Designing your lesson plan...",
                        "🎯 Setting learning objectives...",
                        "📚 Organizing activities...",
                        "✨ Polishing the details..."
                    ],
                    game: [
                        "🎮 Creating fun interactions...",
                        "🎲 Rolling the dice of creativity...",
                        "🎯 Designing engaging challenges...",
                        "✨ Making it entertaining..."
                    ],
                    image: [
                        "🎨 Gathering inspiration...",
                        "🖼️ Painting your vision...",
                        "✨ Adding artistic touches...",
                        "📸 Capturing the perfect moment..."
                    ]
                };
                return messages[type] || messages.all;
            }

            getTips() {
                return [
                    "Did you know? Active learning increases student engagement by up to 70%!",
                    "Fun fact: Games can improve memory retention by 90%",
                    "Pro tip: Visual aids help students learn 400% faster",
                    "Hint: The best lessons combine multiple learning styles",
                    "Quick fact: Interactive learning improves problem-solving skills",
                    "Tip: Regular breaks improve learning efficiency",
                    "Did you know? Color coding helps memory retention",
                    "Fun fact: Movement enhances cognitive function",
                    "Pro tip: Stories make lessons more memorable",
                    "Quick fact: Group activities boost social learning"
                ];
            }

            formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            updateLoadingState(type, displayElement) {
                const elapsedTime = Math.floor((Date.now() - this.startTime) / 1000);
                const messages = this.getMessages(type);
                const tips = this.getTips();

                // Update message every 9 seconds (3 dots cycles)
                this.currentMessageIndex = Math.min(
                    Math.floor(elapsedTime / 9),
                    messages.length - 1
                );

                // Update tip every 15 seconds
                this.currentTipIndex = Math.floor(elapsedTime / 15) % tips.length;

                // Update dots every 3 seconds
                const dotCount = Math.floor(elapsedTime / 3) % 4;
                this.dots = '.'.repeat(dotCount);

                const html = `
                    <div class="loading-container fade-in">
                        <div style="display: flex; align-items: center;">
                            <div class="loading-spinner"></div>
                            <div>
                                <div class="loading-message">
                                    ${messages[this.currentMessageIndex]}${this.dots}
                                </div>
                                <div class="loading-progress">
                                    Time elapsed: ${this.formatTime(elapsedTime)}
                                </div>
                                <div class="loading-progress" style="font-style: italic;">
                                    ${tips[this.currentTipIndex]}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                displayElement.innerHTML = html;
            }

            startLoading(type, displayElement) {
                this.startTime = Date.now();
                this.updateLoadingState(type, displayElement);

                // Update every 3 seconds
                const intervalId = setInterval(() => {
                    this.updateLoadingState(type, displayElement);
                }, 3000);

                return intervalId;
            }

            stopLoading(intervalId) {
                clearInterval(intervalId);
            }
        }

        async function fetchLessonDetails() {
            const lessonId = document.getElementById('updateLessonId').value;
            const pupilId = document.getElementById('updatePupilId').value;

            if (!lessonId || !pupilId) {
                alert('Please enter both Lesson ID and Pupil ID');
                return;
            }

            try {
                const lesson = await getLesson(pupilId, lessonId, 'updateLessonResult');

                // Show lesson details section
                const detailsSection = document.getElementById('lessonDetails');
                detailsSection.style.display = 'block';

                // Create basic lesson details and content display
                detailsSection.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <h3>Lesson Details</h3>
                        <div class="lesson-grid">
                            <div class="detail-card">
                                <label>Subject</label>
                                <div class="detail-display">${lesson.subject || 'Not specified'}</div>
                            </div>
                            <div class="detail-card">
                                <label>Topic</label>
                                <div class="detail-display">${lesson.topic || 'Not specified'}</div>
                            </div>
                            <div class="detail-card">
                                <label>Image Description</label>
                                <div class="detail-display">${lesson.imagedescription || 'Not specified'}</div>
                            </div>
                            ${lesson.planactivity ? `
                                <div class="detail-card">
                                    <label>Activity Type</label>
                                    <div class="detail-display">${lesson.planactivity}</div>
                                </div>
                            ` : ''}
                            ${lesson.gametype ? `
                                <div class="detail-card">
                                    <label>Game Type</label>
                                    <div class="detail-display">${lesson.gametype}</div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Content Display Buttons -->
                        <div class="content-buttons">
                            ${lesson.plandescription ? `
                                <button class="content-button" onclick="toggleContent('plan-content-${lessonId}')">
                                    Display Plan
                                </button>
                            ` : ''}
                            ${lesson.gamedescription ? `
                                <button class="content-button" onclick="toggleContent('game-content-${lessonId}')">
                                    Display Game
                                </button>
                            ` : ''}
                            ${lesson.imageurl ? `
                                <button class="content-button" onclick="toggleContent('image-content-${lessonId}')">
                                    Display Image
                                </button>
                            ` : ''}
                        </div>

                        <!-- Collapsible Content Sections -->
                        ${lesson.plandescription ? `
                            <div id="plan-content-${lessonId}" class="content-section" style="display: none;">
                                <div class="content-header">
                                    <h4>Plan Content</h4>
                                    <button class="hide-content-button" onclick="toggleContent('plan-content-${lessonId}')">
                                        Hide Content
                                    </button>
                                </div>
                                <div class="content-body">
                                    ${formatTextContent(lesson.plandescription)}
                                </div>
                            </div>
                        ` : ''}

                        ${lesson.gamedescription ? `
                            <div id="game-content-${lessonId}" class="content-section" style="display: none;">
                                <div class="content-header">
                                    <h4>Game Content</h4>
                                    <button class="hide-content-button" onclick="toggleContent('game-content-${lessonId}')">
                                        Hide Content
                                    </button>
                                </div>
                                <div class="content-body">
                                    ${formatTextContent(lesson.gamedescription)}
                                </div>
                            </div>
                        ` : ''}

                        ${lesson.imageurl ? `
                            <div id="image-content-${lessonId}" class="content-section" style="display: none;">
                                <div class="content-header">
                                    <h4>Image Content</h4>
                                    <button class="hide-content-button" onclick="toggleContent('image-content-${lessonId}')">
                                        Hide Content
                                    </button>
                                </div>
                                <div class="content-body">
                                    <img src="${lesson.imageurl}" alt="Generated lesson image" style="max-width: 300px;">
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Generation Options Section -->
                    <div style="margin-top: 2rem;">
                        <h3>Generation Options</h3>
                        <div class="generation-buttons" style="display: flex; gap: 10px;">
                            <button onclick="toggleGenerationOptions('all')" class="hide-content-button">Regenerate All</button>
                            <button onclick="toggleGenerationOptions('plan')" class="hide-content-button">Generate Plan</button>
                            <button onclick="toggleGenerationOptions('game')" class="hide-content-button">Generate Game</button>
                            <button onclick="toggleGenerationOptions('image')" class="hide-content-button">Generate Image</button>
                        </div>

                        <!-- Generation Option Forms -->
                        <div id="allGenerationOptions" class="generation-options" style="display: none;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div style="display: flex; flex-direction: column;">
                                    <label for="updateActivityType">Activity Type</label>
                                    <select id="updateActivityType">
                                        <option value="Classroom">Frontal lecture in class</option>
                                        <option value="Computerized">A computerized class</option>
                                        <option value="GroupWork">Group discussion</option>
                                        <option value="OutSide">Lesson outside the classroom</option>
                                        <option value="Remote">Online lesson</option>
                                        <option value="Emotional">Based on personality traits</option>
                                        <option value="Reinforcement">Based on interests</option>
                                    </select>
                                </div>
                                <div style="display: flex; flex-direction: column;">
                                    <label for="updateKnownGame">Known Game</label>
                                    <select id="updateKnownGame">
                                        <option value="Hangman">Hangman</option>
                                        <option value="Memory">Memory</option>
                                        <option value="Charades">Charades</option>
                                        <option value="Bingo">Bingo</option>
                                        <option value="ScavengerHunt">Scavenger Hunt</option>
                                    </select>
                                </div>
                                <div style="display: flex; flex-direction: column;">
                                    <label for="updateImageDescription">Image Description</label>
                                    <input type="text" id="updateImageDescription" placeholder="Enter image description">
                                </div>
                            </div>
                            <button onclick="handleGeneration('all')" class="hide-content-button" style="margin-top: 1rem;">Generate All</button>
                        </div>

                        <div id="planGenerationOptions" class="generation-options" style="display: none;">
                            <div style="display: flex; flex-direction: column; max-width: 250px;">
                                <label for="updatePlanActivityType">Activity Type</label>
                                <select id="updatePlanActivityType">
                                    <option value="Classroom">Frontal lecture in class</option>
                                    <option value="Computerized">A computerized class</option>
                                    <option value="GroupWork">Group discussion</option>
                                    <option value="OutSide">Lesson outside the classroom</option>
                                    <option value="Remote">Online lesson</option>
                                    <option value="Emotional">Based on personality traits</option>
                                    <option value="Reinforcement">Based on interests</option>
                                </select>
                            </div>
                            <button onclick="handleGeneration('plan')" class="hide-content-button" style="margin-top: 1rem;">Generate Plan</button>
                        </div>

                        <div id="gameGenerationOptions" class="generation-options" style="display: none;">
                            <div style="display: flex; flex-direction: column; max-width: 250px;">
                                <label for="updateGameType">Known Game</label>
                                <select id="updateGameType">
                                    <option value="Hangman">Hangman</option>
                                    <option value="Memory">Memory</option>
                                    <option value="Charades">Charades</option>
                                    <option value="Bingo">Bingo</option>
                                    <option value="ScavengerHunt">Scavenger Hunt</option>
                                </select>
                            </div>
                            <button onclick="handleGeneration('game')" class="hide-content-button" style="margin-top: 1rem;">Generate Game</button>
                        </div>

                        <div id="imageGenerationOptions" class="generation-options" style="display: none;">
                            <div style="display: flex; flex-direction: column; max-width: 250px;">
                                <label for="updateImageDesc">Image Description</label>
                                <input type="text" id="updateImageDesc" placeholder="Enter image description">
                            </div>
                            <button onclick="handleGeneration('image')" class="hide-content-button" style="margin-top: 1rem;">Generate Image</button>
                        </div>
                    </div>
                `;

            } catch (error) {
                document.getElementById('updateLessonResult').innerHTML =
                    `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        function toggleContent(contentId) {
            const contentElement = document.getElementById(contentId);
            if (contentElement) {
                contentElement.style.display = contentElement.style.display === 'none' ? 'block' : 'none';
            }
        }

        function toggleGenerationOptions(type) {
            // Hide all generation options first
            document.querySelectorAll('.generation-options').forEach(option => {
                option.style.display = 'none';
            });

            // Show selected generation options
            const optionsId = type + 'GenerationOptions';
            const optionsElement = document.getElementById(optionsId);
            if (optionsElement.style.display === 'none') {
                optionsElement.style.display = 'block';
            } else {
                optionsElement.style.display = 'none';
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.container').forEach(container => {
                container.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
            document.querySelectorAll('.hide-content-button').forEach(button => {
                button.classList.remove('active');
            });
            event.target.classList.add('active');

            // Reset update lesson form when switching sections
            if (sectionId !== 'updateLesson') {
                resetUpdateLessonForm();
            }
        }

        function resetUpdateLessonForm() {
            document.getElementById('lessonDetails').style.display = 'none';
            document.getElementById('updateLessonId').value = '';
            document.getElementById('updatePupilId').value = '';
            document.querySelectorAll('.generation-options').forEach(option => {
                option.style.display = 'none';
            });
            document.getElementById('updateLessonResult').innerHTML = '';
        }


        // Show search section by default
        document.getElementById('searchLessons').style.display = 'block';
    </script>
</body>
</html>